@model List<Product>
@using e_commerce_website.Helpers

@{
    HashSet<string> colors = new HashSet<string>();
    HashSet<string> brands = new HashSet<string>();
}

@functions {
    public string GetRatingColors(int rating)
        {
        return rating switch
            {
                1 => "background-color:tomato; color:white;",
                2 => "background-color:orange; color:white;",
                3 => "background-color:yellow;",
                4 => "background-color:blue; color:white;",
                _ => "background-color:green; color:white;"
                };
        }
    }


@if(Model.Count == 0 && !string.IsNullOrEmpty(ViewData["Query"] as string))
    {
    <div id="no-products">
        <h2>No products found for "<span><strong>@ViewData["Query"]</strong></span>"</h2>
        <p>Try searching for something else.</p>
    </div>
    return;
    }

    <!-- DROPDOWN MENU-->

 <div class="top-right-container">
<div class="dropdown">
    <button class="dropdown-toggle" onclick="toggleDropdown()">Filter & Sort By ▾</button>

    <div id="dropdown-menu" class="dropdown-menu hidden">
        <div class="section">
            <h4>Sort By</h4>
            <label>
                <input type="radio" name="sort" value="low-high" />
                Price: Low to High
            </label>
            <label>
                <input type="radio" name="sort" value="high-low" />
                Price: High to Low
            </label>
        </div>

        <div class="section">
            <h4>Filter By</h4>

            <div class="filter-group">
                <label>Color:</label>
                <select name="color">
                    <option value="all">All</option>
                        @foreach(var item in Model)
                            {
                            var variants = item.Variants;

                            @foreach(var variant in variants)
                                {
                                if (!colors.Contains(variant.Color))
                                    {
                                    <option value="@variant.Color">@StringHelper.CapitalizeEachWord(variant.Color)</option>

                                    }
                                colors.Add(variant.Color);
                                }

                            }
                    </select>
            </div>

            <div class="filter-group">
                <label>Brand:</label>
                <select name="brand">
                    <option value="all">All</option>
                        @foreach (var item in Model)
                            {
                            var brand = item.Brand.BrandName;

                                if (!brands.Contains(brand))
                                    {
                                    <option value="brand">@StringHelper.CapitalizeEachWord(brand)</option>

                                    }
                                brands.Add(brand);

                            }
                    </select>
            </div>

            <div class="filter-group">
                    <label>Price Range: <span id="price-range-display">₹100 - ₹5000</span></label>
                    <input type="range" id="priceRange" min="100" max="5000" step="100" value="5000" oninput="updatePriceDisplay(this)">
            </div>
            <div class="filter-sort-btns">
                <button class="clear-btn all" onclick="clearAll()">Clear Filters</button>
                <button class="apply-btn all" onclick="handleApplyFilter()">Apply Filters</button>
            </div>
        </div>
    </div>
</div>
</div>
<!-- PRODUCT LISTING-->

<div id="search-result-feedback" style="display:none; width: 80%; margin: auto; margin-top: 20px;">
    <h2 id="search-result-feedback-content"></h2>
</div>
<div class="product-container">
    <div id="product-inner-container" class="product-inner-container">
        <! ------------ PRODUCTS WILL BE DYNAMICALLY CREATED ----------------- -->

        @foreach (var product in Model)
            {
            var primaryVariant = product.Variants?.FirstOrDefault();
            var primaryImage = primaryVariant?.Images?.FirstOrDefault(i => i.IsPrimary) ?? primaryVariant?.Images?.FirstOrDefault();
            var avgRating = (product.Reviews != null && product.Reviews.Count > 0)
            ? Math.Round(product.Reviews.Average(r => r.Rating))
            : 5; // Default rating if no reviews

            var ratingCount = product.Reviews?.Count ?? 0;
            var ratingColor = GetRatingColors(ratingCount);


            <div class="product-grid">
                <a asp-controller="Product" asp-action="Details" asp-route-category="@product.Category?.CategoryName" asp-route-id="@product.ProductID" target="_blank">
                    <div class="product-image">
                        <img src="@primaryImage?.ImageUrl" alt="@product.ProductName" />
                    </div>
                    <div class="product-information">
                        <h4>@StringHelper.CapitalizeEachWord(product.ProductName)</h4>
                        <p>@StringHelper.CapitalizeEachWord(product.Description)</p>
                        <p class="product-price">$@primaryVariant?.Price.ToString("0.00")</p>
                        <div class="ratings">
                            <span class="rating" style="@ratingColor">@avgRating★</span>
                            <span class="rating-count">@ratingCount ratings</span>
                        </div>
                    </div>
                </a>
            </div>
            }
    </div>
</div>